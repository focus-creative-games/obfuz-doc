"use strict";(self.webpackChunkobfuz=self.webpackChunkobfuz||[]).push([[2150],{8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var i=t(6540);const s={},r=i.createContext(s);function a(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:n},e.children)}},9231:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"beginner/work-with-xlua","title":"Obfuz+XLua","description":"This project demonstrates how to use Obfuz with XLua. For the complete sample project, see WorkWithXLua.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/beginner/work-with-xlua.md","sourceDirName":"beginner","slug":"/beginner/work-with-xlua","permalink":"/en/docs/beginner/work-with-xlua","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/beginner/work-with-xlua.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Obfuz+HybridCLR","permalink":"/en/docs/beginner/work-with-hybridclr"},"next":{"title":"\u624b\u518c","permalink":"/en/docs/manual"}}');var s=t(4848),r=t(8453);const a={},o="Obfuz+XLua",c={},l=[{value:"Installation",id:"installation",level:2},{value:"Create Code",id:"create-code",level:2},{value:"Edit Scene",id:"edit-scene",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Generate Encryption Virtual Machine and Keys",id:"generate-encryption-virtual-machine-and-keys",level:2},{value:"Register Types Accessed in xLua",id:"register-types-accessed-in-xlua",level:2},{value:"Build &amp; Run",id:"build--run",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"obfuzxlua",children:"Obfuz+XLua"})}),"\n",(0,s.jsxs)(n.p,{children:["This project demonstrates how to use Obfuz with XLua. For the complete sample project, see ",(0,s.jsx)(n.a,{href:"https://github.com/focus-creative-games/obfuz-samples/tree/main/WorkWithXLua",children:"WorkWithXLua"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For detailed documentation, see ",(0,s.jsx)(n.a,{href:"../manual/xlua/work-with-xlua",children:"Working with XLua"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.p,{children:"Install the following plugins:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["com.code-philosophy.obfuz ",(0,s.jsx)(n.code,{children:"https://github.com/focus-creative-games/obfuz.git"})]}),"\n",(0,s.jsxs)(n.li,{children:["xlua ",(0,s.jsx)(n.code,{children:"https://github.com/Tencent/xLua"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Since xlua does not directly provide a separate package repository, this sample project is directly modified from the xLua repository."}),"\n",(0,s.jsx)(n.h2,{id:"create-code",children:"Create Code"}),"\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.code,{children:"Bootstrap.cs"})," class in the Assets directory with the following code:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'using Obfuz;\nusing Obfuz.EncryptionVM;\nusing System.Collections;\nusing System.Collections.Generic;\nusing Tutorial;\nusing UnityEngine;\n\n\npublic class Bootstrap : MonoBehaviour\n{\n    [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.AfterAssembliesLoaded)]\n    private static void SetUpStaticSecretKey()\n    {\n        //Debug.Log("SetUpStaticSecret begin");\n        EncryptionService<DefaultStaticEncryptionScope>.Encryptor = new GeneratedEncryptionVirtualMachine(Resources.Load<TextAsset>("Obfuz/defaultStaticSecretKey").bytes);\n        //Debug.Log("SetUpStaticSecret end");\n    }\n\n    private void Awake()\n    {\n        ObfuscationInstincts.RegisterReflectionType<BaseClass>();\n        ObfuscationInstincts.RegisterReflectionType<DerivedClass>();\n        ObfuscationInstincts.RegisterReflectionType<Tutorial.ICalc>();\n        ObfuscationInstincts.RegisterReflectionType<DerivedClass.InnerCalc>();\n        ObfuscationInstincts.RegisterReflectionType<DerivedClass.TestEnumInner>();\n        ObfuscationInstincts.RegisterReflectionType<Tutorial.TestEnum>();\n    }\n\n    void Start()\n    {\n        Debug.Log("Hello, Obfuz");\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"edit-scene",children:"Edit Scene"}),"\n",(0,s.jsxs)(n.p,{children:["Attach the ",(0,s.jsx)(n.code,{children:"Boostrap"})," and ",(0,s.jsx)(n.code,{children:"Tutorial.LuaCallCs"})," scripts to the scene."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"Tutorial.LuaCallCs"})," is a demo script that comes with the xLua repository, located in the ",(0,s.jsx)(n.code,{children:"Assets/XLua/Tutorial/CSharpCallLua"})," directory."]}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Add Assembly-CSharp to the ",(0,s.jsx)(n.code,{children:"ObfuzSettings.AssembliesToObfuscate"})," list"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"generate-encryption-virtual-machine-and-keys",children:"Generate Encryption Virtual Machine and Keys"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Run the menu ",(0,s.jsx)(n.code,{children:"Obfuz/GenerateEncryptionVM"})," to generate encryption virtual machine code. The default generated code file is ",(0,s.jsx)(n.code,{children:"Assets/Obfuz/GeneratedEncryptionVirtualMachine.cs"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Run the menu ",(0,s.jsx)(n.code,{children:"Obfuz/GenerateSecretKeyFile"})," to generate two key files. The default output files are ",(0,s.jsx)(n.code,{children:"Assets/Resources/Obfuz/defaultStaticSecretKey.bytes"})," and ",(0,s.jsx)(n.code,{children:"Assets/Resources/Obfuz/defaultDynamicSecretKey.bytes"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"register-types-accessed-in-xlua",children:"Register Types Accessed in xLua"}),"\n",(0,s.jsxs)(n.p,{children:["When xLua registers C# types, it doesn't directly use the type name, but instead calls Type.FullName. This causes a ",(0,s.jsx)(n.code,{children:"type not found"})," error when accessing C# classes in lua code after obfuscation!"]}),"\n",(0,s.jsxs)(n.p,{children:["A more thorough solution is to adjust the xlua implementation so that type names are determined directly when generating wrapper code, but this is more complex. We have adopted a simpler solution: using ",(0,s.jsx)(n.code,{children:"ObfuscationTypeMapper"})," provided by Obfuz\nto get the original type name corresponding to the Type, and modify all code in xLua that calls ",(0,s.jsx)(n.code,{children:"Type.FullName"})," to ",(0,s.jsx)(n.code,{children:"ObfuscationTypeMapper.GetOriginalTypeFullNameOrCurrent"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For ObfuscationTypeMapper to work correctly, it is required to register the mapping relationship between Type and the original type full name in advance. Writing type full names by hand is error-prone, and ",(0,s.jsx)(n.code,{children:"ObfuscationInstincts::RegisterReflectionType"})," provides a very convenient registration method."]}),"\n",(0,s.jsx)(n.p,{children:"We have added registration code in the Bootstrap.Awake function."}),"\n",(0,s.jsx)(n.h2,{id:"build--run",children:"Build & Run"}),"\n",(0,s.jsxs)(n.p,{children:["Run ",(0,s.jsx)(n.code,{children:"Build And Run"})," in ",(0,s.jsx)(n.code,{children:"Build Settings"})," to build and run. Check the player.log to verify that it is running correctly."]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);